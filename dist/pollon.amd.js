/* @pollon/pollon - v1.0.0
* https://github.com/pollon-js/pollon#readme
* 2020 Francesco Lasaracina. Licensed ISC */
define(["exports","@pollon/light-dom","@pollon/state-machine","@pollon/message-broker"],(function(e,t,n,r){"use strict";function o(e){return new Promise((function(t){setTimeout(t,e)}))}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function u(e,t,n){return t&&a(e.prototype,t),n&&a(e,n),e}function l(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function h(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function f(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=c(e);if(t){var o=c(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return h(this,n)}}function d(e,t,n){return(d="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=c(e)););return e}(e,t);if(r){var o=Object.getOwnPropertyDescriptor(r,t);return o.get?o.get.call(n):o.value}})(e,t,n||e)}function v(e,t){return m(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var n=[],r=!0,o=!1,i=void 0;try{for(var a,u=e[Symbol.iterator]();!(r=(a=u.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){o=!0,i=e}finally{try{r||null==u.return||u.return()}finally{if(o)throw i}}return n}(e,t)||g(e,t)||b()}function p(e){return function(e){if(Array.isArray(e))return w(e)}(e)||y(e)||g(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function m(e){if(Array.isArray(e))return e}function y(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function g(e,t){if(e){if("string"==typeof e)return w(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?w(e,t):void 0}}function w(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function b(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function k(e){return"string"==Object.prototype.toString.call(e).match(/^\[object\s(.*)\]$/)[1].toLowerCase()}var P={APPEND:"lifecycle.injection-mode.append",PREPEND:"lifecycle.injection-mode.prepend",REPLACE:"lifecycle.injection-mode.replace"},E=function(e,t){e.setAttribute("data-view-state",t)},R=function(e){var n;if(!k(e.root))throw new Error("Pollon: [kernel:lifecycle] Root must be a valid CSS selector");if(!(n=t.Query(document).one(e.root)).length)throw new Error("Pollon: [kernel:lifecycle] Root must be a valid node");switch(E(e.node.get(0),"detached"),e.injectionMode){case M.INJECTION_MODES.APPEND:n.append(e.node);break;case M.INJECTION_MODES.PREPEND:n.prepend(e.node);break;case M.INJECTION_MODES.REPLACE:n.replace(e.node)}},M=function(){function e(r){i(this,e),this.root=null,this.injectionMode=null,this.ID=r,this.node=t.Query.element("div",{"data-view":r}),this.FSM=new n.StateMachine({initial:"detached",transitions:{detached:{initialize:"initialized"},initialized:{load:"loaded"},loaded:{applyBindings:"bound"},bound:{dispose:"disposed"},disposed:{restart:"initialized"}}})}return u(e,null,[{key:"EVENTS",get:function(){return n.StateMachine.EVENTS}},{key:"INJECTION_MODES",get:function(){return P}}]),u(e,[{key:"initialize",value:function(e){var t=this;return this.FSM.can("initialize")?new Promise((function(n,r){E(t.node.get(0),"detached"),R(t),n(e)})).then(this.FSM.handle.bind(this.FSM,"initialize")):Promise.resolve(e)}},{key:"load",value:function(e){var n=this;return this.FSM.can("load")?new Promise((function(r,o){var i;i=n.node.get(0),document.body==i||document.body.compareDocumentPosition(i)&Node.DOCUMENT_POSITION_CONTAINED_BY||R(n),void 0===e&&(e=t.Query.element("<div>").get(0)),n.node.replace(e),E(n.node.get(0),"loaded"),r(e)})).then(this.FSM.handle.bind(this.FSM,"load")):Promise.resolve(e)}},{key:"applyBindings",value:function(){var e=this;if(!this.FSM.can("applyBindings"))return Promise.resolve();for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return this.FSM.handle("applyBindings",n).then((function(){E(e.node.get(0),"ready")}))}},{key:"dispose",value:function(){var e=this;return this.FSM.can("dispose")?this.FSM.handle("dispose",this.node.get(0)).then((function(t){t||e.node.unbind(),E(e.node.get(0),"disposed")})).then((function(){return e.FSM.handle("restart")})):Promise.resolve()}}]),e}(),N=function(e,t){if(e[t]){for(var n=arguments.length,r=new Array(n>2?n-2:0),o=2;o<n;o++)r[o-2]=arguments[o];return e[t].apply(e,r)}},S=function(){function e(t){i(this,e),this.Module=t}return u(e,[{key:"init",value:function(){return N(this.Module.View,"init")}},{key:"onLoad",value:function(e){return N(this.Module.View,"onLoad",e)}},{key:"onApplyBindings",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return N.apply(void 0,[this.Module.View,"onApplyBindings"].concat(t))}},{key:"onDispose",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return N.apply(void 0,[this.Module.View,"onDispose"].concat(t))}}]),e}();function A(e){return e instanceof Function}function I(){var e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?n:7&n|8).toString(16)}))}function T(e){return"object"==Object.prototype.toString.call(e).match(/^\[object\s(.*)\]$/)[1].toLowerCase()}var D=function(){function e(){i(this,e)}return u(e,null,[{key:"create",value:function(t){if(t instanceof e)return t;if(!T(t)&&!A(t))throw new Error("Pollon: [Module:invalid] module must be either an object, a function or a Module instance");A(t)&&(t=t.prototype&&t.prototype.constructor.name?new t:t());var n=new e;return Object.assign(t,n)}}]),u(e,[{key:"canActivate",value:function(){return!0}},{key:"canDeactivate",value:function(){return!0}}]),e}();var x=function(){function e(){i(this,e),this.store={}}return u(e,[{key:"put",value:function(e,t){this.store[e]=t}},{key:"get",value:function(e){return this.store[e]}}]),e}(),O=function(){function e(t){i(this,e),this.appName=t,this.cache=new x,this.extension=".jpt"}return u(e,[{key:"canParse",value:function(e){return-1<e.indexOf(this.extension,e.length-this.extension)}},{key:"getInfo",value:function(e){var t;if(this.canParse(e))return{id:t=e.substring(0,e.length-this.extension.length),path:t+this.extension}}},{key:"get",value:function(e){var t,n,r=this;return this.canParse(e)?(n=this.getInfo(e),t=ee.get(this.appName),new Promise((function(o,i){t.loadText(n.path).then((function(e){o(e)})).catch((function(t){r.onUnloadable(e,n,t).then((function(e){o(e)}))}))}))):Promise.reject()}},{key:"onUnloadable",value:function(e,t,n){var r;return r='Not Found. Searched for "'+t.id+'" via path "'+t.path+'".',Promise.resolve(r)}}]),e}(),j=function(e){var t,n,r;if((t=document.createElement("div")).innerHTML=e,!(n=t.childNodes).length)return t.cloneNode(!0);if(1==n.length)return n[0].cloneNode(!0);if(r=[],n.forEach((function(e){if(3==e.nodeType&&(!/\S/.test(e.nodeValue)||!e.nodeValue.trim()))return;r.push(e)})),r.length>1){var o=document.createElement("div");return r.forEach((function(e){o.appendChild(e)})),o.cloneNode(!0)}return r[0].cloneNode(!0)},_=function(e){l(n,e);var t=f(n);function n(e){var r;return i(this,n),(r=t.call(this,e)).extension=".jpt",r}return u(n,[{key:"get",value:function(e){var t,r=this;if(k(e))return this.canParse(e)?(t=this.getInfo(e),this.cache.get(t.id)?new Promise((function(e,n){e(r.cache.get(t.id).cloneNode(!0))})):d(c(n.prototype),"get",this).call(this,e).then((function(e){var n=j(e.trim());return r.cache.put(t.id,n),n.cloneNode(!0)}))):Promise.reject("Pollon: [template:html] ".concat(e," element is unparseable by the HTML loader"));if(!function(e){return e&&1===e.nodeType||e&&11===e.nodeType||e&&9===e.nodeType}(e))throw new Error("Pollon: [template:html] You must pass either a file path or a DOM Node for the HTML Loader to work properly");return j(e).cloneNode(!0)}},{key:"onUnloadable",value:function(e,t,r){return d(c(n.prototype),"onUnloadable",this).call(this,e,t,r).then((function(e){return j('<div class="view-404">Template '.concat(e,"</div>"))})).catch((function(e){return j('<div class="view-404">Template '.concat(e,"</div>"))}))}}]),n}(O),L=function(){function e(t){if(i(this,e),!t.name)throw new Error("Pollon [router:route:invalid] Route must have a name!");this.name=t.name,this.pattern=e.parse(t.pattern)[0],this.params=e.parse(t.pattern)[1],this.path=t.path||"",this.ID=t.module,this.parentID=null,this.handler=function(){},this.args=null,this.injection={point:t.injection.point,mode:t.injection.mode}}return u(e,null,[{key:"parse",value:function(e){var t;return t=[],[e.replace(/(:[^/<>]+)(?:<([^>]+)>)?/g,(function(n,r,o){if(r.split(" ").length>1)throw new Error("Pollon: [router:route:invalid] Invalid route pattern: ".concat(e));return t.push(r),o?"("+o+")":"([^/]+)"})),t]}}]),e}(),B=function(e){return e&&e.toString().replace(/^\//,"").replace(/\/$/,"")},F=function(){function e(t){i(this,e),this.routes={},this.current={},this.mode="onpopstate",this.initialized=!1,this.preventPushStateForInnerRecursiveCalls=!1,this.baseUrl=t,this.onNavigationStart=function(){},this.recursiveCounter=0}return u(e,[{key:"patternMatch",value:function(e){var t;return void 0!==this.current.hash&&(e=B(e),!!(t=this.current.hash.match(e))&&(t.shift(),t))}},{key:"match",value:function(e){var t,n=Object.entries(e);if(void 0===this.current.hash)return!1;for(var r=0,o=n;r<o.length;r++){var i=v(o[r],2)[1];if(t=this.patternMatch(i.pattern),t)return[i,t]}return!1}},{key:"add",value:function(e){this.routes[e.name]=e}},{key:"remove",value:function(e){var t;t=this.routes.filter((function(t){return t.pattern!=e.pattern})),this.routes=t}},{key:"getByName",value:function(e){return this.routes[e]&&this.routes[e]}},{key:"executeRoute",value:function(e){var t,n,r=this;if(this.current.hash=B(e),!(n=this.match(this.routes)))return Promise.reject("Pollon: [router:route:not-found] Route ".concat(e," not found"));t=[].concat(n[1]||[]);for(var o=arguments.length,i=new Array(o>1?o-1:0),a=1;a<o;a++)i[a-1]=arguments[a];return i&&(t=n[1].concat(i)),n[0].handler.apply({},t).then((function(t){if(t)if(r.recursiveCounter=0,"onhashchange"==r.mode)window.location.href=window.location.href.replace(/#(.*)$/,"")+"#"+B(e);else{var n=r.initialized?"pushState":"replaceState";if(r.initialized=!0,!r.preventPushStateForInnerRecursiveCalls){var o=document.createElement("a");o.href=window.location.origin.replace(/$\/+/,"")+"/"+e.replace(/^\/+/,""),history[n](null,null,o.href)}}}))}},{key:"listen",value:function(){var e=this;window[this.mode]=function(){var t;t="onhashchange"==e.mode?(t=window.location.href.match(/#(.*)$/))?t[1]:"":(t=B(decodeURI(location.pathname+location.search))).replace(/\?(.*)$/,""),e.preventPushStateForInnerRecursiveCalls=!0,t!=e.current.hash?e.navigate(t,void 0):e.navigate(e.current.hash,void 0)}}},{key:"navigate",value:function(e){for(var t=this,n=arguments.length,r=new Array(n>1?n-1:0),o=1;o<n;o++)r[o-1]=arguments[o];if(this.recursiveCounter++,this.recursiveCounter>=10)throw"Pollon [router:lifecycle] navigation loop detected";if(e=this.baseUrl+e,this.current.hash===e)return Promise.resolve();var i=this.current.hash;return Promise.resolve().then((function(){return t.onNavigationStart.apply(t,[e].concat(r))})).then((function(){return t.executeRoute.apply(t,[e].concat(r))})).then((function(){t.preventPushStateForInnerRecursiveCalls=!1})).catch((function(e){if(t.current.hash=B(i),"onhashchange"==t.mode?window.location.href=window.location.href.replace(/#(.*)$/,"")+"#"+i:history.pushState(null,null,window.location.href),console.warn(e),e&&e.url)return console.warn("Pollon [router:lifecycle] Redirecting to ".concat(e.url)),t.navigate(e.url,e.args||void 0);throw t.recursiveCounter=0,e}))}},{key:"navigateBack",value:function(){window.history.back()}},{key:"navigateForward",value:function(){window.history.forward()}}]),e}();function C(e,t){return t=t||"./",0===e.indexOf("@")&&(t=""),t+e}var U=function(e,t,n){return t.path=t.path||C(t.ID,e),n(t.path).then((function(e){if(e.Runtime&&t.injection.point){var n=function(e,t,n){var r;if(e||(e=P.APPEND),!t)throw new Error('Pollon: [Router] Invalid injection options for Module  "'.concat(n.ID,'"'));if(!(r=Object.values(P).filter((function(t){return e==t}))).length)throw new Error('Pollon: [Router] Invalid injection method for Module  "'.concat(n.ID,'"'));return{point:t,mode:r[0]}}(t.injection.mode,t.injection.point,e);e.Runtime.injectionMode=n.mode,e.Runtime.root=n.point}return e}))},V=function e(t,n,r,o,i){return n.path=n.path||C(n.ID,t),U(t,n,o).then((function(e){return r.length&&(r[r.length-1].module=e),e})).then((function(a){if(!a)return r;if(!a.Router)return r;a.Router.routes=Array.isArray(a.Router.routes)?a.Router.routes:[];var u=function(e,t,n){var r;return e.forEach((function(e){var o,i,a,u,l,c;r||e.pattern&&(o=L.parse(t.pattern),a=L.parse(e.pattern),i=o[0].replace(/^[\^]/,""),u=a[0].replace(/^[\^]/,""),l=(l=i?i+"/"+u:u).replace(/\/$/,""),(c=n(new RegExp(l)))&&((r=new L(e)).pattern=l,r.args=c.slice(-a[1].length),r.parentID=t.ID,console.info("Pollon: [router] Discovering new child route: ".concat(r.name," with: "),r.args)))})),r||new Error("Pollon: [router:child-route-not-found] Child route for ".concat(t.name," not found")),r}(a.Router.routes,n,i);return u?(r.push(u),e(t,u,r,o,i)):r}))},z=function(e,t,n,r){return V(e,t,[t],n,r)},$=function(e,t){return Promise.resolve({off:e.reverse(),on:[t],active:[t]})},G=function(e,t,n){return t.then((r=n.module,function(t){return e.kernel.canDeactivateModule(r).then((function(e){return e.url?e:e&&t}))}));var r},H=function(e,t,n,r){return n.then((o=r.module,i=r.args||[],function(n){var r;return(r=e.kernel).canActivateModule.apply(r,[o].concat(p(i.concat(t)))).then((function(e){return e&&e.url?e:e&&n})).catch(console.log.bind(console))}));var o,i};function J(e,t,n){return t?new Promise((function(r,o){t.off.reduce(G.bind(null,e),Promise.resolve(!0)).then((function(e){e||o()})).then((function(){return t.on.reduce(H.bind(null,e,n),Promise.resolve(!0))})).then((function(e){e&&e.url?o(e):e?r(t):o(e)})).catch(o.bind(o))})):{off:[],on:[],active:[]}}function K(e,t,n,r,o){var i,a,u,l,c,s;if((i=Array.isArray(e)?Array.prototype.slice.call(e):[],u={active:a=Array.isArray(t)?Array.prototype.slice.call(t):[],on:[],off:[]},a.length)&&!((l=a.slice().reverse())[0].pattern.length?n.match(l[0].pattern):n==l[0].pattern))return $(i,o);if(!i.length)return u.off=[],u.on=a,Promise.resolve(u);if(!a.length)return $(i,o);for(c=0,s=0;c<i.length&&a[s]&&a[s].pattern===i[c].pattern;c++,s++);return u.off=(i.slice(c)||[]).reverse(),u.on=a.slice(s)||[],0==u.on.length&&0==u.off.length&&(r!=n||!(arguments.length<=5)&&arguments.length-5)&&u.active.length&&(u.off=[u.active[u.active.length-1]],u.on=[u.active[u.active.length-1]]),Promise.resolve(u)}var W=function(e){var t=this;return function(){for(var n=arguments.length,r=new Array(n),o=0;o<n;o++)r[o]=arguments[o];return z(t.baseUrl,e,t.kernel.getModule.bind(t.kernel),t.Router.patternMatch.bind(t.Router)).then((function(e){var n;if((n=(n=L.parse(e[e.length-1].pattern)[0].replace(/^[\^]/,"")).replace(/\/$/,""))&&!t.currentPath.match(new RegExp("^"+n+"$")))throw console.warn(n,t.currentPath),new Error("Pollon: [router:not-found] route not found for ".concat(t.currentPath));return e})).then((function(e){return t._404?(t._404.module?Promise.resolve(t._404.module):U(t.baseUrl,t._404,t.kernel.getModule.bind(t.kernel))).then((function(n){return t._404.module=n,K.apply(void 0,[t.stack,e,t.currentPath,t.lastFetchedUrl,t._404].concat(r))})):Promise.resolve()})).catch((function(e){return console.warn(e),(t._404.module?Promise.resolve(t._404.module):U(t.baseUrl,t._404,t.kernel.getModule.bind(t.kernel))).then((function(e){return t._404.module=e,{on:[t._404],off:(t.stack||[]).reverse(),active:[t._404]}}))})).then((function(n){var o=(e.args||[]).concat(r);return t.workflow.reduce((function(e,t){var r=n.on[n.on.length-1];return r||(r=n.off[0]),e.then((function(){return t.apply(void 0,[r].concat(p(o)))}))}),Promise.resolve()).then((function(){return n})).catch((function(e){if(console.log(e),e&&e.url)throw e;return{on:[],off:[],active:n.active,preventNavigation:!0,reason:"Pollon [router:lifecycle] A navigation policy prevented navigation to ".concat(t.Router.current.hash)}}))})).then((function(n){if(n.on&&n.off)return J(t,n,r).catch((function(e){if(console.log(e),console.warn("Pollon [router:lifecycle] failed to activate or deactivate module",t.Router.current.hash),e&&e.url)throw e;return{on:[],off:[],active:n.active,preventNavigation:!0,reason:"Pollon [router:lifecycle] failed to activate or deactivate module ".concat(t.Router.current.hash)}}));throw new Error("Pollon [router:not-found] route ".concat(e.name," not found"))})).then((function(e){var n,o,i,a,u;if(u=t.kernel.currentModule,e.preventNavigation)throw e.reason;i=Array.prototype.slice.apply(e.off),a=Array.prototype.slice.apply(e.on),n=function(e){return e?(console.info("Pollon [router:deactivating] ".concat(e.ID)),t.kernel.deactivate(e.path).then((function(){var e=i.shift();return n(e)}))):Promise.resolve()},o=function(e){var n;if(t.kernel.currentModule=null,!e)return Promise.resolve();console.info("Pollon [router:activating]",e.ID,"route-params:",e.args,"injected-params:",r);var i=e.args||[];return i=i.slice().concat(r||[]),(n=t.kernel.activate).call.apply(n,[t.kernel,e.path].concat(p(i))).then((function(){var e=a.shift();return o(e)}))};var l=i.shift();return n(l).then((function(){var n=a.shift();return o(n).then((function(){var n,o;t.stack.length&&(!e.on.length&&t.stack[t.stack.length-2]&&t.stack[t.stack.length-2].module&&t.stack[t.stack.length-2].module.resumeFromChildren&&(o=(t.stack[t.stack.length-2].args||[]).slice().concat(r||[]))&&(n=t.stack[t.stack.length-2].module).resumeFromChildren.apply(n,p(o)));return t.stack=e.active,t.lastFetchedUrl=t.Router.current.hash,t.kernel.currentModule=e.active&&e.active[e.active.length-1].module,t.kernel.busy(!1),!0})).catch((function(e){throw t.kernel.currentModule=u,t.kernel.busy(!1),e}))}))}))}},q=function(){function e(t,n){i(this,e),this.Router=new F(t.baseUrl),this.Router.onNavigationStart=this.onNavigationStart.bind(this),this.baseUrl=t.baseUrl,this.appRoot=t.selector,this.lastFetchedUrl=null,this.kernel=t.kernel,this.workflow=n.workflow||[],this.stack=[],this.fallbackStack=[],this._404=null,n.routes&&Array.isArray(n.routes)&&this.map(n.routes)}return u(e,[{key:"currentPath",get:function(){return this.Router.current.hash}}]),u(e,[{key:"map",value:function(e){var t=this;(e=Array.isArray(e)?e:[e]).forEach((function(e){e.name&&(t.Router.getByName(e.name)&&console.warn("Pollon [router:map] Skipping ".concat(e.name,": route already exists")),(e=new L(e)).handler=W.call(t,e),"404"!=e.name||t._404||(t._404=e),t.Router.add(e))}))}},{key:"listen",value:function(){this.Router.listen()}},{key:"canNavigate",value:function(){return!this.kernel.busy()}},{key:"onNavigationStart",value:function(e){this.kernel.busy(!0)}},{key:"navigate",value:function(e){for(var t,n=this,r=arguments.length,i=new Array(r>1?r-1:0),a=1;a<r;a++)i[a-1]=arguments[a];return o(1).then((function(){var r;if(n.canNavigate())return t=n.kernel.currentModule,(r=n.Router).navigate.apply(r,[e].concat(i))})).catch((function(e){throw n.kernel.currentModule=t,n.kernel.busy(!1),e}))}},{key:"navigateBack",value:function(){var e,t=this;return o(1).then((function(){if(t.canNavigate())return e=t.kernel.currentModule,t.Router.navigateBack()})).catch((function(n){throw t.kernel.currentModule=e,t.kernel.busy(!1),n}))}},{key:"navigateForward",value:function(){var e,t=this;return o(1).then((function(){if(t.canNavigate())return e=t.kernel.currentModule,t.Router.navigateForward()})).catch((function(n){throw t.kernel.currentModule=e,t.kernel.busy(!1),n}))}}]),e}(),Q=function(e){l(n,e);var t=f(n);function n(e){var r;return i(this,n),(r=t.call(this,ee.STARTED)).appName=e,r}return n}(r.Event),Y=function(e){l(n,e);var t=f(n);function n(){return i(this,n),t.call(this,ee.NAVIGATION_START)}return n}(r.Event),X=function(e){l(n,e);var t=f(n);function n(){return i(this,n),t.call(this,ee.NAVIGATION_END)}return n}(r.Event),Z={},ee=function(){function e(t,n){var o=this;if(i(this,e),!t)throw new Error("Pollon: [application] application must have a name");if(Z[t]&&Z[t].instance)throw new Error("Pollon: [application:exists] another application called ".concat(t," already exists"));this.name=t,this.root=n.root||"body",this.baseUrl=void 0!==n.baseUrl?n.baseUrl:"./";var a=n.loader||null,u=n.binder||null;this.kernel=new de(t,a,u),this.publisher=new r.Publisher([e.STARTED,e.NAVIGATION_START,e.NAVIGATION_END]),this.Templates={HTML:new _(this.name)},this.Bus=new r.Broker,this.Providers=new r.Broker,this.Bus.add(this.publisher),this.busy.subscribe((function(t,n){if("busy"==n.status)return document.querySelector(o.root).classList.add("is-transitioning"),void o.publisher.fire(e.NAVIGATION_START,new Y);document.querySelector(o.root).classList.remove("is-transitioning"),o.publisher.fire(e.NAVIGATION_END,new X),o.kernel.currentModule&&(document.querySelector(o.root).setAttribute("active-view",o.kernel.currentModule.name),o.kernel.currentModule.title&&(document.title=o.kernel.currentModule.title))})),Z[this.name]={instance:this,prepared:!1,started:!1,loader:a,plugins:[],routes:[],navigationWorkflow:[]},u.init(this)}return u(e,[{key:"busy",get:function(){return this.kernel.busy}},{key:"moduleInitialized",get:function(){return this.kernel.moduleInitialized}},{key:"moduleLoaded",get:function(){return this.kernel.moduleLoaded}},{key:"moduleReady",get:function(){return this.kernel.moduleReady}},{key:"moduleDisposed",get:function(){return this.kernel.moduleDisposed}}],[{key:"get",value:function(e){if(Z[e])return Z[e].instance}},{key:"STARTED",get:function(){return"application.started"}},{key:"NAVIGATION_START",get:function(){return"application.navigation.start"}},{key:"NAVIGATION_END",get:function(){return"application.navigation.end"}}]),u(e,[{key:"loadText",value:function(e){if(Z[this.name].loader)return Z[this.name].loader.loadText(e);throw new Error("Pollon: [application:strategies:unset] LoadText strategy is missing.")}},{key:"load",value:function(e){if(Z[this.name].loader)return Z[this.name].loader.load(e);throw new Error("Pollon: [application:strategies:unset] Load strategy is missing.")}},{key:"loadPlugins",value:function(e){if(Z[this.name].loader)return Z[this.name].loader.loadPlugins(e);if(!e.length)throw new Error("Pollon: [application:strategies:unset] Plugin loading strategy is missing");return[]}},{key:"resolvePluginURI",value:function(e,t){return Z[this.name].loader?Z[this.name].loader.resolvePluginURI(e,t):t}},{key:"routes",value:function(e){var t;return Z[this.name].routes=(t=Z[this.name].routes).concat.apply(t,p(e)),this}},{key:"navigationStep",value:function(){var e;return Z[this.name].navigationWorkflow=(e=Z[this.name].navigationWorkflow).concat.apply(e,arguments),this}},{key:"use",value:function(e,t){var n=this;return Object.keys(e).forEach((function(r){Z[n.name].plugins.push({name:r,url:n.resolvePluginURI(r,t),config:e[r]})})),this}},{key:"prepare",value:function(){var e=this;if(Z[this.name]&&!Z[this.name].prepared){Z[this.name].prepared=!0;var t=[];return Z[this.name].plugins.forEach((function(e){t.push(e.url)})),this.loadPlugins(t).then((function(t){var n,r=(m(n=t)||y(n)||g(n)||b()).slice(0),o=-1;return r.map((function(t){var n,r;return o++,r=Z[e.name].plugins[o].name,n=T(n=Z[e.name].plugins[o].config)?n:n(e.name),n=T(n)?n:{},t.install?{name:r,canInstall:!0,plugin:t,config:n}:{name:r,canInstall:!1,plugin:t}})).reduce((function(t,n){return t.then((function(){var t;return n.canInstall&&(t=n.plugin.install(e,n.config)),(t=t&&t.then?t:Promise.resolve()).then((function(){return n}))})).then((function(e){console.info("Pollon: [Plugin:installed] ".concat(e.name))})).catch(console.error.bind(console))}),Promise.resolve())}))}}},{key:"start",value:function(){if(Z[this.name]&&!Z[this.name].started&&(Z[this.name].started=!0,Z[this.name].routes.length)){var t=new q(this,{routes:Z[this.name].routes,workflow:Z[this.name].navigationWorkflow});this.navigate=t.navigate.bind(t),this.navigateBack=t.navigateBack.bind(t),this.navigateForward=t.navigateForward.bind(t),this.currentPath=function(){return t.currentPath};var n=Z[this.name].routes.filter((function(e){return!!e.default}));return t.listen(),this.publisher.fire(e.STARTED,new Q(this.name)),n.length&&this.navigate(n[0].pattern)}}}]),e}(),te="kernel.status",ne="kernel.module.initialized",re="kernel.module.loaded",oe="kernel.module.ready",ie="kernel.module.disposed",ae=function(e){l(n,e);var t=f(n);function n(e){var r;return i(this,n),(r=t.call(this,te)).status=e?"busy":"idle",r}return n}(r.Event);function ue(e){var t,n;return(n=function(n){return void 0===n?!!t:(t=!!n,e.publisher.fire(te,new ae(!!n),e))}).subscribe=function(t,n){var o={};o[te]={method:t,once:!!n},e.Bus.add(new r.Subscriber(o))},n}var le=function(e){l(n,e);var t=f(n);function n(e){var r;return i(this,n),(r=t.call(this,ne)).module=e,r}return n}(r.Event);var ce=function(e){l(n,e);var t=f(n);function n(e){var r;return i(this,n),(r=t.call(this,re)).module=e,r}return n}(r.Event);var se=function(e){l(n,e);var t=f(n);function n(e,r){var o;return i(this,n),(o=t.call(this,oe)).module=e,o.args=r,o}return n}(r.Event);var he=function(e){l(n,e);var t=f(n);function n(e){var r;return i(this,n),(r=t.call(this,ie)).module=e,r}return n}(r.Event);var fe=function(e,t,n){return t},de=function(){function e(t,n,o){var a,u,l,c;if(i(this,e),!n||!n.loadModule)throw new Error("Pollon: [application:strategies:unset] Module loading strategy is missing.");a=n.loadModule.bind(n),o&&o.applyBindings?u=o.applyBindings.bind(o):(console.warn("Pollon: [application:strategies:unset] MVVM strategy is missing. Default strategy is being used (no binding)"),u=fe),this.loadTemplate=function(e){return function(t){var n=ee.get(e);if(t&&t.View&&t.View.template)return n.Templates.HTML.get(t.View.template)}}(t),this.loadModule=a,this.applyBindings=u,this.appName=t,this.modules={},this.currentModule=null,this._transitionDelay=300,this.busy=ue(this),this.moduleInitialized=(l=this,(c=function(e){return l.publisher.fire(ne,new le(e),l)}).subscribe=function(e,t){var n={};n[ne]={method:e,once:!!t},l.Bus.add(new r.Subscriber(n))},c),this.moduleLoaded=function(e){var t;return(t=function(t){return e.publisher.fire(re,new ce(t),e)}).subscribe=function(t,n){var o={};o[re]={method:t,once:!!n},e.Bus.add(new r.Subscriber(o))},t}(this),this.moduleReady=function(e){var t;return(t=function(t,n){return e.publisher.fire(oe,new se(t,n),e)}).subscribe=function(t,n){var o={};o[oe]={method:t,once:!!n},e.Bus.add(new r.Subscriber(o))},t}(this),this.moduleDisposed=function(e){var t;return(t=function(t){return e.publisher.fire(ie,new he(t),e)}).subscribe=function(t,n){var o={};o[ie]={method:t,once:!!n},e.Bus.add(new r.Subscriber(o))},t}(this),this.busy=ue(this),this.Bus=new r.Broker,this.publisher=new r.Publisher([te,ne,ie,re,oe]),this.Bus.add(this.publisher)}return u(e,[{key:"getModule",value:function(e){var t,n=this;if(this.modules[e])return Promise.resolve(this.modules[e]);try{t=this.loadModule(this.appName,e)}catch(t){throw new Error("Pollon: [Kernel:module:loading] Cannot load module ".concat(e,": ").concat(t))}if(!t)throw new Error("Pollon: [Kernel:module:loading] Cannot load module ".concat(e));return t.then||(t=Promise.resolve(t)),t.then((function(t){return(t=D.create(t)).ID=e,t.Runtime=new M(e),n.modules[e]=t,t})).then((function(e){return e.Runtime.FSM.on(M.EVENTS.ON,"initialize",(function(t,r){return e.appName=r.args[0],n.moduleInitialized(e.name),e.Lifecycle&&A(e.Lifecycle.init)&&e.Lifecycle.init()})),e.Runtime.FSM.on(M.EVENTS.ENTERED,"loaded",(function(t,r){var o;return n.moduleLoaded(e.name),e.Lifecycle&&A(e.Lifecycle.onLoad)&&(o=e.Lifecycle).onLoad.apply(o,p(r.args||[]))})),e.Runtime.FSM.on(M.EVENTS.ENTERED,"bound",(function(t,n){var r;return e.Lifecycle&&A(e.Lifecycle.onApplyBindings)&&(r=e.Lifecycle.onApplyBindings).apply.apply(r,[e.Lifecycle].concat(p(n.args||[])))})),e.Runtime.FSM.on(M.EVENTS.ENTERED,"disposed",(function(t,r){var o;return n.moduleDisposed(e.name),e.Lifecycle&&A(e.Lifecycle.onDispose)&&(o=e.Lifecycle).onDispose.apply(o,p(r.args||[]))})),e.onReady=e.onReady&&e.onReady.bind(e)||function(){for(var t=arguments.length,r=new Array(t),o=0;o<t;o++)r[o]=arguments[o];return n.moduleReady(e.name,r)},e}))}},{key:"canDeactivateModule",value:function(e){var t=this;return e.Runtime?new Promise((function(n,r){var o;try{o=e.canDeactivate&&e.canDeactivate(t.appName)}catch(e){n(!1)}return o&&o.then?o.then((function(e){n(e)})).catch(n.bind(n)):n(o)})):Promise.resolve(!0)}},{key:"canActivateModule",value:function(e){for(var t=this,n=arguments.length,r=new Array(n>1?n-1:0),o=1;o<n;o++)r[o-1]=arguments[o];return e.Runtime?new Promise((function(n,o){var i;try{i=e.canActivate&&e.canActivate.apply(e,[t.appName].concat(r))}catch(e){o(e)}return i&&i.then?i.then((function(e){n(e)})).catch(o.bind(o)):n(i)})):Promise.resolve(!0)}},{key:"deactivate",value:function(e){var t=this;return console.log("deactivate",e),this.getModule(e).then((function(n){return t.canDeactivateModule(n).then((function(t){if(!t)throw new Error("Pollon: [kernel:module:deactivation] Unable to deactivate module ".concat(e));return n.Runtime.dispose()}))})).catch(console.info.bind(console))}},{key:"activate",value:function(e){for(var t=this,n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return e?(this.currentModule?this.deactivate(this.currentModule.Runtime.ID):Promise.resolve(!0)).then((function(){return t.getModule(e)})).then((function(e){return t.canActivateModule.apply(t,[e].concat(r))})).then((function(n){var o;if(!n)throw new Error("Pollon: [kernel:module:activation] Unable to activate module ".concat(e));return(o=t.modules[e].Runtime).initialize.apply(o,[t.appName].concat(r))})).then((function(){var n=t.modules[e];return t.loadTemplate(n)})).then((function(n){return t.modules[e].Runtime.load(n)})).then((function(){var n;(n=t.modules[e]).Runtime.node&&(n.name||(n.name="unknown-module-"+I()),n.Runtime.node.attr("data-view",n.name))})).then((function(){var n=t.modules[e];return t.applyBindings(ee.get(t.appName),n.Runtime.node.get(0),n)})).then((function(){var n;return(n=t.modules[e].Runtime).applyBindings.apply(n,r)})).then((function(){return t._transitionDelay&&o(t._transitionDelay)})).then((function(){var n;return t.currentModule=t.modules[e],t.moduleReady(t.currentModule.name,r),t.currentModule.onReady&&(n=t.currentModule).onReady.apply(n,r)})).catch(console.error.bind(console)):Promise.resolve()}},{key:"setTransitionDelay",value:function(e){this._transitionDelay=+e}}]),e}();e.Application=ee,e.HTMLLoader=_,e.INJECTION_MODES=P,e.Kernel=de,e.KernelLifecycle=M,e.Lifecycle=S,e.Module=D,e.RedirectCommand=function e(t){i(this,e),this.url=t},e.RedirectExternalURICommand=function e(t){i(this,e),window.location.href=t},e.TemplateLoader=O,e.wait=o,Object.defineProperty(e,"__esModule",{value:!0})}));
