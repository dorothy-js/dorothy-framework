/* @pollon/pollon - v1.0.0
* https://github.com/pollon-js/pollon#readme
* 2020 Francesco Lasaracina. Licensed ISC */
System.register(["@pollon/light-dom","@pollon/state-machine","@pollon/message-broker"],(function(e){"use strict";var t,n,r,o,i,a;return{setters:[function(e){t=e.Query},function(e){n=e.StateMachine},function(e){r=e.Publisher,o=e.Broker,i=e.Event,a=e.Subscriber}],execute:function(){function u(e){return new Promise((function(t){setTimeout(t,e)}))}function c(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function l(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t,n){return t&&l(e.prototype,t),n&&l(e,n),e}function h(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&d(e,t)}function f(e){return(f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function v(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function p(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=f(e);if(t){var o=f(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return v(this,n)}}function m(e,t,n){return(m="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=f(e)););return e}(e,t);if(r){var o=Object.getOwnPropertyDescriptor(r,t);return o.get?o.get.call(n):o.value}})(e,t,n||e)}function y(e,t){return w(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var n=[],r=!0,o=!1,i=void 0;try{for(var a,u=e[Symbol.iterator]();!(r=(a=u.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){o=!0,i=e}finally{try{r||null==u.return||u.return()}finally{if(o)throw i}}return n}(e,t)||b(e,t)||R()}function g(e){return function(e){if(Array.isArray(e))return P(e)}(e)||k(e)||b(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function w(e){if(Array.isArray(e))return e}function k(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function b(e,t){if(e){if("string"==typeof e)return P(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?P(e,t):void 0}}function P(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function R(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function E(e){return"string"==Object.prototype.toString.call(e).match(/^\[object\s(.*)\]$/)[1].toLowerCase()}e("wait",u);var M=e("INJECTION_MODES",{APPEND:"lifecycle.injection-mode.append",PREPEND:"lifecycle.injection-mode.prepend",REPLACE:"lifecycle.injection-mode.replace"}),N=function(e,t){e.setAttribute("data-view-state",t)},A=function(e){var n;if(!E(e.root))throw new Error("Pollon: [kernel:lifecycle] Root must be a valid CSS selector");if(!(n=t(document).one(e.root)).length)throw new Error("Pollon: [kernel:lifecycle] Root must be a valid node");switch(N(e.node.get(0),"detached"),e.injectionMode){case S.INJECTION_MODES.APPEND:n.append(e.node);break;case S.INJECTION_MODES.PREPEND:n.prepend(e.node);break;case S.INJECTION_MODES.REPLACE:n.replace(e.node)}},S=e("KernelLifecycle",function(){function e(r){c(this,e),this.root=null,this.injectionMode=null,this.ID=r,this.node=t.element("div",{"data-view":r}),this.FSM=new n({initial:"detached",transitions:{detached:{initialize:"initialized"},initialized:{load:"loaded"},loaded:{applyBindings:"bound"},bound:{dispose:"disposed"},disposed:{restart:"initialized"}}})}return s(e,null,[{key:"EVENTS",get:function(){return n.EVENTS}},{key:"INJECTION_MODES",get:function(){return M}}]),s(e,[{key:"initialize",value:function(e){var t=this;return this.FSM.can("initialize")?new Promise((function(n,r){N(t.node.get(0),"detached"),A(t),n(e)})).then(this.FSM.handle.bind(this.FSM,"initialize")):Promise.resolve(e)}},{key:"load",value:function(e){var n=this;return this.FSM.can("load")?new Promise((function(r,o){var i;i=n.node.get(0),document.body==i||document.body.compareDocumentPosition(i)&Node.DOCUMENT_POSITION_CONTAINED_BY||A(n),void 0===e&&(e=t.element("<div>").get(0)),n.node.replace(e),N(n.node.get(0),"loaded"),r(e)})).then(this.FSM.handle.bind(this.FSM,"load")):Promise.resolve(e)}},{key:"applyBindings",value:function(){var e=this;if(!this.FSM.can("applyBindings"))return Promise.resolve();for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return this.FSM.handle("applyBindings",n).then((function(){N(e.node.get(0),"ready")}))}},{key:"dispose",value:function(){var e=this;return this.FSM.can("dispose")?this.FSM.handle("dispose",this.node.get(0)).then((function(t){t||e.node.unbind(),N(e.node.get(0),"disposed")})).then((function(){return e.FSM.handle("restart")})):Promise.resolve()}}]),e}()),I=function(e,t){if(e[t]){for(var n=arguments.length,r=new Array(n>2?n-2:0),o=2;o<n;o++)r[o-2]=arguments[o];return e[t].apply(e,r)}};e("Lifecycle",function(){function e(t){c(this,e),this.Module=t}return s(e,[{key:"init",value:function(){return I(this.Module.View,"init")}},{key:"onLoad",value:function(e){return I(this.Module.View,"onLoad",e)}},{key:"onApplyBindings",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return I.apply(void 0,[this.Module.View,"onApplyBindings"].concat(t))}},{key:"onDispose",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return I.apply(void 0,[this.Module.View,"onDispose"].concat(t))}}]),e}());function T(e){return e instanceof Function}function D(){var e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?n:7&n|8).toString(16)}))}function x(e){return"object"==Object.prototype.toString.call(e).match(/^\[object\s(.*)\]$/)[1].toLowerCase()}var O=e("Module",function(){function e(){c(this,e)}return s(e,null,[{key:"create",value:function(t){if(t instanceof e)return t;if(!x(t)&&!T(t))throw new Error("Pollon: [Module:invalid] module must be either an object, a function or a Module instance");T(t)&&(t=t.prototype&&t.prototype.constructor.name?new t:t());var n=new e;return Object.assign(t,n)}}]),s(e,[{key:"canActivate",value:function(){return!0}},{key:"canDeactivate",value:function(){return!0}}]),e}());var j=function(){function e(){c(this,e),this.store={}}return s(e,[{key:"put",value:function(e,t){this.store[e]=t}},{key:"get",value:function(e){return this.store[e]}}]),e}(),_=e("TemplateLoader",function(){function e(t){c(this,e),this.appName=t,this.cache=new j,this.extension=".jpt"}return s(e,[{key:"canParse",value:function(e){return-1<e.indexOf(this.extension,e.length-this.extension)}},{key:"getInfo",value:function(e){var t;if(this.canParse(e))return{id:t=e.substring(0,e.length-this.extension.length),path:t+this.extension}}},{key:"get",value:function(e){var t,n,r=this;return this.canParse(e)?(n=this.getInfo(e),t=ne.get(this.appName),new Promise((function(o,i){t.loadText(n.path).then((function(e){o(e)})).catch((function(t){r.onUnloadable(e,n,t).then((function(e){o(e)}))}))}))):Promise.reject()}},{key:"onUnloadable",value:function(e,t,n){var r;return r='Not Found. Searched for "'+t.id+'" via path "'+t.path+'".',Promise.resolve(r)}}]),e}()),L=function(e){var t,n,r;if((t=document.createElement("div")).innerHTML=e,!(n=t.childNodes).length)return t.cloneNode(!0);if(1==n.length)return n[0].cloneNode(!0);if(r=[],n.forEach((function(e){if(3==e.nodeType&&(!/\S/.test(e.nodeValue)||!e.nodeValue.trim()))return;r.push(e)})),r.length>1){var o=document.createElement("div");return r.forEach((function(e){o.appendChild(e)})),o.cloneNode(!0)}return r[0].cloneNode(!0)},F=e("HTMLLoader",function(e){h(n,e);var t=p(n);function n(e){var r;return c(this,n),(r=t.call(this,e)).extension=".jpt",r}return s(n,[{key:"get",value:function(e){var t,r=this;if(E(e))return this.canParse(e)?(t=this.getInfo(e),this.cache.get(t.id)?new Promise((function(e,n){e(r.cache.get(t.id).cloneNode(!0))})):m(f(n.prototype),"get",this).call(this,e).then((function(e){var n=L(e.trim());return r.cache.put(t.id,n),n.cloneNode(!0)}))):Promise.reject("Pollon: [template:html] ".concat(e," element is unparseable by the HTML loader"));if(!function(e){return e&&1===e.nodeType||e&&11===e.nodeType||e&&9===e.nodeType}(e))throw new Error("Pollon: [template:html] You must pass either a file path or a DOM Node for the HTML Loader to work properly");return L(e).cloneNode(!0)}},{key:"onUnloadable",value:function(e,t,r){return m(f(n.prototype),"onUnloadable",this).call(this,e,t,r).then((function(e){return L('<div class="view-404">Template '.concat(e,"</div>"))})).catch((function(e){return L('<div class="view-404">Template '.concat(e,"</div>"))}))}}]),n}(_)),B=function(){function e(t){if(c(this,e),!t.name)throw new Error("Pollon [router:route:invalid] Route must have a name!");this.name=t.name,this.pattern=e.parse(t.pattern)[0],this.params=e.parse(t.pattern)[1],this.path=t.path||"",this.ID=t.module,this.parentID=null,this.handler=function(){},this.args=null,this.injection={point:t.injection.point,mode:t.injection.mode}}return s(e,null,[{key:"parse",value:function(e){var t;return t=[],[e.replace(/(:[^/<>]+)(?:<([^>]+)>)?/g,(function(n,r,o){if(r.split(" ").length>1)throw new Error("Pollon: [router:route:invalid] Invalid route pattern: ".concat(e));return t.push(r),o?"("+o+")":"([^/]+)"})),t]}}]),e}(),C=function(e){return e&&e.toString().replace(/^\//,"").replace(/\/$/,"")},U=function(){function e(t){c(this,e),this.routes={},this.current={},this.mode="onpopstate",this.initialized=!1,this.preventPushStateForInnerRecursiveCalls=!1,this.baseUrl=t,this.onNavigationStart=function(){},this.recursiveCounter=0}return s(e,[{key:"patternMatch",value:function(e){var t;return void 0!==this.current.hash&&(e=C(e),!!(t=this.current.hash.match(e))&&(t.shift(),t))}},{key:"match",value:function(e){var t,n=Object.entries(e);if(void 0===this.current.hash)return!1;for(var r=0,o=n;r<o.length;r++){var i=y(o[r],2)[1];if(t=this.patternMatch(i.pattern),t)return[i,t]}return!1}},{key:"add",value:function(e){this.routes[e.name]=e}},{key:"remove",value:function(e){var t;t=this.routes.filter((function(t){return t.pattern!=e.pattern})),this.routes=t}},{key:"getByName",value:function(e){return this.routes[e]&&this.routes[e]}},{key:"executeRoute",value:function(e){var t,n,r=this;if(this.current.hash=C(e),!(n=this.match(this.routes)))return Promise.reject("Pollon: [router:route:not-found] Route ".concat(e," not found"));t=[].concat(n[1]||[]);for(var o=arguments.length,i=new Array(o>1?o-1:0),a=1;a<o;a++)i[a-1]=arguments[a];return i&&(t=n[1].concat(i)),n[0].handler.apply({},t).then((function(t){if(t)if(r.recursiveCounter=0,"onhashchange"==r.mode)window.location.href=window.location.href.replace(/#(.*)$/,"")+"#"+C(e);else{var n=r.initialized?"pushState":"replaceState";if(r.initialized=!0,!r.preventPushStateForInnerRecursiveCalls){var o=document.createElement("a");o.href=window.location.origin.replace(/$\/+/,"")+"/"+e.replace(/^\/+/,""),history[n](null,null,o.href)}}}))}},{key:"listen",value:function(){var e=this;window[this.mode]=function(){var t;t="onhashchange"==e.mode?(t=window.location.href.match(/#(.*)$/))?t[1]:"":(t=C(decodeURI(location.pathname+location.search))).replace(/\?(.*)$/,""),e.preventPushStateForInnerRecursiveCalls=!0,t!=e.current.hash?e.navigate(t,void 0):e.navigate(e.current.hash,void 0)}}},{key:"navigate",value:function(e){for(var t=this,n=arguments.length,r=new Array(n>1?n-1:0),o=1;o<n;o++)r[o-1]=arguments[o];if(this.recursiveCounter++,this.recursiveCounter>=10)throw"Pollon [router:lifecycle] navigation loop detected";if(e=this.baseUrl+e,this.current.hash===e)return Promise.resolve();var i=this.current.hash;return Promise.resolve().then((function(){return t.onNavigationStart.apply(t,[e].concat(r))})).then((function(){return t.executeRoute.apply(t,[e].concat(r))})).then((function(){t.preventPushStateForInnerRecursiveCalls=!1})).catch((function(e){if(t.current.hash=C(i),"onhashchange"==t.mode?window.location.href=window.location.href.replace(/#(.*)$/,"")+"#"+i:history.pushState(null,null,window.location.href),console.warn(e),e&&e.url)return console.warn("Pollon [router:lifecycle] Redirecting to ".concat(e.url)),t.navigate(e.url,e.args||void 0);throw t.recursiveCounter=0,e}))}},{key:"navigateBack",value:function(){window.history.back()}},{key:"navigateForward",value:function(){window.history.forward()}}]),e}();function V(e,t){return t=t||"./",0===e.indexOf("@")&&(t=""),t+e}var z=function(e,t,n){return t.path=t.path||V(t.ID,e),n(t.path).then((function(e){if(e.Runtime&&t.injection.point){var n=function(e,t,n){var r;if(e||(e=M.APPEND),!t)throw new Error('Pollon: [Router] Invalid injection options for Module  "'.concat(n.ID,'"'));if(!(r=Object.values(M).filter((function(t){return e==t}))).length)throw new Error('Pollon: [Router] Invalid injection method for Module  "'.concat(n.ID,'"'));return{point:t,mode:r[0]}}(t.injection.mode,t.injection.point,e);e.Runtime.injectionMode=n.mode,e.Runtime.root=n.point}return e}))},$=function e(t,n,r,o,i){return n.path=n.path||V(n.ID,t),z(t,n,o).then((function(e){return r.length&&(r[r.length-1].module=e),e})).then((function(a){if(!a)return r;if(!a.Router)return r;a.Router.routes=Array.isArray(a.Router.routes)?a.Router.routes:[];var u=function(e,t,n){var r;return e.forEach((function(e){var o,i,a,u,c,l;r||e.pattern&&(o=B.parse(t.pattern),a=B.parse(e.pattern),i=o[0].replace(/^[\^]/,""),u=a[0].replace(/^[\^]/,""),c=(c=i?i+"/"+u:u).replace(/\/$/,""),(l=n(new RegExp(c)))&&((r=new B(e)).pattern=c,r.args=l.slice(-a[1].length),r.parentID=t.ID,console.info("Pollon: [router] Discovering new child route: ".concat(r.name," with: "),r.args)))})),r||new Error("Pollon: [router:child-route-not-found] Child route for ".concat(t.name," not found")),r}(a.Router.routes,n,i);return u?(r.push(u),e(t,u,r,o,i)):r}))},G=function(e,t,n,r){return $(e,t,[t],n,r)},H=function(e,t){return Promise.resolve({off:e.reverse(),on:[t],active:[t]})},J=function(e,t,n){return t.then((r=n.module,function(t){return e.kernel.canDeactivateModule(r).then((function(e){return e.url?e:e&&t}))}));var r},K=function(e,t,n,r){return n.then((o=r.module,i=r.args||[],function(n){var r;return(r=e.kernel).canActivateModule.apply(r,[o].concat(g(i.concat(t)))).then((function(e){return e&&e.url?e:e&&n})).catch(console.log.bind(console))}));var o,i};function W(e,t,n){return t?new Promise((function(r,o){t.off.reduce(J.bind(null,e),Promise.resolve(!0)).then((function(e){e||o()})).then((function(){return t.on.reduce(K.bind(null,e,n),Promise.resolve(!0))})).then((function(e){e&&e.url?o(e):e?r(t):o(e)})).catch(o.bind(o))})):{off:[],on:[],active:[]}}function q(e,t,n,r,o){var i,a,u,c,l,s;if((i=Array.isArray(e)?Array.prototype.slice.call(e):[],u={active:a=Array.isArray(t)?Array.prototype.slice.call(t):[],on:[],off:[]},a.length)&&!((c=a.slice().reverse())[0].pattern.length?n.match(c[0].pattern):n==c[0].pattern))return H(i,o);if(!i.length)return u.off=[],u.on=a,Promise.resolve(u);if(!a.length)return H(i,o);for(l=0,s=0;l<i.length&&a[s]&&a[s].pattern===i[l].pattern;l++,s++);return u.off=(i.slice(l)||[]).reverse(),u.on=a.slice(s)||[],0==u.on.length&&0==u.off.length&&(r!=n||!(arguments.length<=5)&&arguments.length-5)&&u.active.length&&(u.off=[u.active[u.active.length-1]],u.on=[u.active[u.active.length-1]]),Promise.resolve(u)}var Y=function(e){var t=this;return function(){for(var n=arguments.length,r=new Array(n),o=0;o<n;o++)r[o]=arguments[o];return G(t.baseUrl,e,t.kernel.getModule.bind(t.kernel),t.Router.patternMatch.bind(t.Router)).then((function(e){var n;if((n=(n=B.parse(e[e.length-1].pattern)[0].replace(/^[\^]/,"")).replace(/\/$/,""))&&!t.currentPath.match(new RegExp("^"+n+"$")))throw console.warn(n,t.currentPath),new Error("Pollon: [router:not-found] route not found for ".concat(t.currentPath));return e})).then((function(e){return t._404?(t._404.module?Promise.resolve(t._404.module):z(t.baseUrl,t._404,t.kernel.getModule.bind(t.kernel))).then((function(n){return t._404.module=n,q.apply(void 0,[t.stack,e,t.currentPath,t.lastFetchedUrl,t._404].concat(r))})):Promise.resolve()})).catch((function(e){return console.warn(e),(t._404.module?Promise.resolve(t._404.module):z(t.baseUrl,t._404,t.kernel.getModule.bind(t.kernel))).then((function(e){return t._404.module=e,{on:[t._404],off:(t.stack||[]).reverse(),active:[t._404]}}))})).then((function(n){var o=(e.args||[]).concat(r);return t.workflow.reduce((function(e,t){var r=n.on[n.on.length-1];return r||(r=n.off[0]),e.then((function(){return t.apply(void 0,[r].concat(g(o)))}))}),Promise.resolve()).then((function(){return n})).catch((function(e){if(console.log(e),e&&e.url)throw e;return{on:[],off:[],active:n.active,preventNavigation:!0,reason:"Pollon [router:lifecycle] A navigation policy prevented navigation to ".concat(t.Router.current.hash)}}))})).then((function(n){if(n.on&&n.off)return W(t,n,r).catch((function(e){if(console.log(e),console.warn("Pollon [router:lifecycle] failed to activate or deactivate module",t.Router.current.hash),e&&e.url)throw e;return{on:[],off:[],active:n.active,preventNavigation:!0,reason:"Pollon [router:lifecycle] failed to activate or deactivate module ".concat(t.Router.current.hash)}}));throw new Error("Pollon [router:not-found] route ".concat(e.name," not found"))})).then((function(e){var n,o,i,a,u;if(u=t.kernel.currentModule,e.preventNavigation)throw e.reason;i=Array.prototype.slice.apply(e.off),a=Array.prototype.slice.apply(e.on),n=function(e){return e?(console.info("Pollon [router:deactivating] ".concat(e.ID)),t.kernel.deactivate(e.path).then((function(){var e=i.shift();return n(e)}))):Promise.resolve()},o=function(e){var n;if(t.kernel.currentModule=null,!e)return Promise.resolve();console.info("Pollon [router:activating]",e.ID,"route-params:",e.args,"injected-params:",r);var i=e.args||[];return i=i.slice().concat(r||[]),(n=t.kernel.activate).call.apply(n,[t.kernel,e.path].concat(g(i))).then((function(){var e=a.shift();return o(e)}))};var c=i.shift();return n(c).then((function(){var n=a.shift();return o(n).then((function(){var n,o;t.stack.length&&(!e.on.length&&t.stack[t.stack.length-2]&&t.stack[t.stack.length-2].module&&t.stack[t.stack.length-2].module.resumeFromChildren&&(o=(t.stack[t.stack.length-2].args||[]).slice().concat(r||[]))&&(n=t.stack[t.stack.length-2].module).resumeFromChildren.apply(n,g(o)));return t.stack=e.active,t.lastFetchedUrl=t.Router.current.hash,t.kernel.currentModule=e.active&&e.active[e.active.length-1].module,t.kernel.busy(!1),!0})).catch((function(e){throw t.kernel.currentModule=u,t.kernel.busy(!1),e}))}))}))}},Q=function(){function e(t,n){c(this,e),this.Router=new U(t.baseUrl),this.Router.onNavigationStart=this.onNavigationStart.bind(this),this.baseUrl=t.baseUrl,this.appRoot=t.selector,this.lastFetchedUrl=null,this.kernel=t.kernel,this.workflow=n.workflow||[],this.stack=[],this.fallbackStack=[],this._404=null,n.routes&&Array.isArray(n.routes)&&this.map(n.routes)}return s(e,[{key:"currentPath",get:function(){return this.Router.current.hash}}]),s(e,[{key:"map",value:function(e){var t=this;(e=Array.isArray(e)?e:[e]).forEach((function(e){e.name&&(t.Router.getByName(e.name)&&console.warn("Pollon [router:map] Skipping ".concat(e.name,": route already exists")),(e=new B(e)).handler=Y.call(t,e),"404"!=e.name||t._404||(t._404=e),t.Router.add(e))}))}},{key:"listen",value:function(){this.Router.listen()}},{key:"canNavigate",value:function(){return!this.kernel.busy()}},{key:"onNavigationStart",value:function(e){this.kernel.busy(!0)}},{key:"navigate",value:function(e){for(var t,n=this,r=arguments.length,o=new Array(r>1?r-1:0),i=1;i<r;i++)o[i-1]=arguments[i];return u(1).then((function(){var r;if(n.canNavigate())return t=n.kernel.currentModule,(r=n.Router).navigate.apply(r,[e].concat(o))})).catch((function(e){throw n.kernel.currentModule=t,n.kernel.busy(!1),e}))}},{key:"navigateBack",value:function(){var e,t=this;return u(1).then((function(){if(t.canNavigate())return e=t.kernel.currentModule,t.Router.navigateBack()})).catch((function(n){throw t.kernel.currentModule=e,t.kernel.busy(!1),n}))}},{key:"navigateForward",value:function(){var e,t=this;return u(1).then((function(){if(t.canNavigate())return e=t.kernel.currentModule,t.Router.navigateForward()})).catch((function(n){throw t.kernel.currentModule=e,t.kernel.busy(!1),n}))}}]),e}(),X=function(e){h(n,e);var t=p(n);function n(e){var r;return c(this,n),(r=t.call(this,ne.STARTED)).appName=e,r}return n}(i),Z=function(e){h(n,e);var t=p(n);function n(){return c(this,n),t.call(this,ne.NAVIGATION_START)}return n}(i),ee=function(e){h(n,e);var t=p(n);function n(){return c(this,n),t.call(this,ne.NAVIGATION_END)}return n}(i),te={},ne=e("Application",function(){function e(t,n){var i=this;if(c(this,e),!t)throw new Error("Pollon: [application] application must have a name");if(te[t]&&te[t].instance)throw new Error("Pollon: [application:exists] another application called ".concat(t," already exists"));this.name=t,this.root=n.root||"body",this.baseUrl=void 0!==n.baseUrl?n.baseUrl:"./";var a=n.loader||null,u=n.binder||null;this.kernel=new pe(t,a,u),this.publisher=new r([e.STARTED,e.NAVIGATION_START,e.NAVIGATION_END]),this.Templates={HTML:new F(this.name)},this.Bus=new o,this.Providers=new o,this.Bus.add(this.publisher),this.busy.subscribe((function(t,n){if("busy"==n.status)return document.querySelector(i.root).classList.add("is-transitioning"),void i.publisher.fire(e.NAVIGATION_START,new Z);document.querySelector(i.root).classList.remove("is-transitioning"),i.publisher.fire(e.NAVIGATION_END,new ee),i.kernel.currentModule&&(document.querySelector(i.root).setAttribute("active-view",i.kernel.currentModule.name),i.kernel.currentModule.title&&(document.title=i.kernel.currentModule.title))})),te[this.name]={instance:this,prepared:!1,started:!1,loader:a,plugins:[],routes:[],navigationWorkflow:[]},u.init(this)}return s(e,[{key:"busy",get:function(){return this.kernel.busy}},{key:"moduleInitialized",get:function(){return this.kernel.moduleInitialized}},{key:"moduleLoaded",get:function(){return this.kernel.moduleLoaded}},{key:"moduleReady",get:function(){return this.kernel.moduleReady}},{key:"moduleDisposed",get:function(){return this.kernel.moduleDisposed}}],[{key:"get",value:function(e){if(te[e])return te[e].instance}},{key:"STARTED",get:function(){return"application.started"}},{key:"NAVIGATION_START",get:function(){return"application.navigation.start"}},{key:"NAVIGATION_END",get:function(){return"application.navigation.end"}}]),s(e,[{key:"loadText",value:function(e){if(te[this.name].loader)return te[this.name].loader.loadText(e);throw new Error("Pollon: [application:strategies:unset] LoadText strategy is missing.")}},{key:"load",value:function(e){if(te[this.name].loader)return te[this.name].loader.load(e);throw new Error("Pollon: [application:strategies:unset] Load strategy is missing.")}},{key:"loadPlugins",value:function(e){if(te[this.name].loader)return te[this.name].loader.loadPlugins(e);if(!e.length)throw new Error("Pollon: [application:strategies:unset] Plugin loading strategy is missing");return[]}},{key:"resolvePluginURI",value:function(e,t){return te[this.name].loader?te[this.name].loader.resolvePluginURI(e,t):t}},{key:"routes",value:function(e){var t;return te[this.name].routes=(t=te[this.name].routes).concat.apply(t,g(e)),this}},{key:"navigationStep",value:function(){var e;return te[this.name].navigationWorkflow=(e=te[this.name].navigationWorkflow).concat.apply(e,arguments),this}},{key:"use",value:function(e,t){var n=this;return Object.keys(e).forEach((function(r){te[n.name].plugins.push({name:r,url:n.resolvePluginURI(r,t),config:e[r]})})),this}},{key:"prepare",value:function(){var e=this;if(te[this.name]&&!te[this.name].prepared){te[this.name].prepared=!0;var t=[];return te[this.name].plugins.forEach((function(e){t.push(e.url)})),this.loadPlugins(t).then((function(t){var n,r=(w(n=t)||k(n)||b(n)||R()).slice(0),o=-1;return r.map((function(t){var n,r;return o++,r=te[e.name].plugins[o].name,n=x(n=te[e.name].plugins[o].config)?n:n(e.name),n=x(n)?n:{},t.install?{name:r,canInstall:!0,plugin:t,config:n}:{name:r,canInstall:!1,plugin:t}})).reduce((function(t,n){return t.then((function(){var t;return n.canInstall&&(t=n.plugin.install(e,n.config)),(t=t&&t.then?t:Promise.resolve()).then((function(){return n}))})).then((function(e){console.info("Pollon: [Plugin:installed] ".concat(e.name))})).catch(console.error.bind(console))}),Promise.resolve())}))}}},{key:"start",value:function(){if(te[this.name]&&!te[this.name].started&&(te[this.name].started=!0,te[this.name].routes.length)){var t=new Q(this,{routes:te[this.name].routes,workflow:te[this.name].navigationWorkflow});this.navigate=t.navigate.bind(t),this.navigateBack=t.navigateBack.bind(t),this.navigateForward=t.navigateForward.bind(t),this.currentPath=function(){return t.currentPath};var n=te[this.name].routes.filter((function(e){return!!e.default}));return t.listen(),this.publisher.fire(e.STARTED,new X(this.name)),n.length&&this.navigate(n[0].pattern)}}}]),e}()),re="kernel.status",oe="kernel.module.initialized",ie="kernel.module.loaded",ae="kernel.module.ready",ue="kernel.module.disposed",ce=function(e){h(n,e);var t=p(n);function n(e){var r;return c(this,n),(r=t.call(this,re)).status=e?"busy":"idle",r}return n}(i);function le(e){var t,n;return(n=function(n){return void 0===n?!!t:(t=!!n,e.publisher.fire(re,new ce(!!n),e))}).subscribe=function(t,n){var r={};r[re]={method:t,once:!!n},e.Bus.add(new a(r))},n}var se=function(e){h(n,e);var t=p(n);function n(e){var r;return c(this,n),(r=t.call(this,oe)).module=e,r}return n}(i);var he=function(e){h(n,e);var t=p(n);function n(e){var r;return c(this,n),(r=t.call(this,ie)).module=e,r}return n}(i);var fe=function(e){h(n,e);var t=p(n);function n(e,r){var o;return c(this,n),(o=t.call(this,ae)).module=e,o.args=r,o}return n}(i);var de=function(e){h(n,e);var t=p(n);function n(e){var r;return c(this,n),(r=t.call(this,ue)).module=e,r}return n}(i);var ve=function(e,t,n){return t},pe=e("Kernel",function(){function e(t,n,i){var u,l,s,h;if(c(this,e),!n||!n.loadModule)throw new Error("Pollon: [application:strategies:unset] Module loading strategy is missing.");u=n.loadModule.bind(n),i&&i.applyBindings?l=i.applyBindings.bind(i):(console.warn("Pollon: [application:strategies:unset] MVVM strategy is missing. Default strategy is being used (no binding)"),l=ve),this.loadTemplate=function(e){return function(t){var n=ne.get(e);if(t&&t.View&&t.View.template)return n.Templates.HTML.get(t.View.template)}}(t),this.loadModule=u,this.applyBindings=l,this.appName=t,this.modules={},this.currentModule=null,this._transitionDelay=300,this.busy=le(this),this.moduleInitialized=(s=this,(h=function(e){return s.publisher.fire(oe,new se(e),s)}).subscribe=function(e,t){var n={};n[oe]={method:e,once:!!t},s.Bus.add(new a(n))},h),this.moduleLoaded=function(e){var t;return(t=function(t){return e.publisher.fire(ie,new he(t),e)}).subscribe=function(t,n){var r={};r[ie]={method:t,once:!!n},e.Bus.add(new a(r))},t}(this),this.moduleReady=function(e){var t;return(t=function(t,n){return e.publisher.fire(ae,new fe(t,n),e)}).subscribe=function(t,n){var r={};r[ae]={method:t,once:!!n},e.Bus.add(new a(r))},t}(this),this.moduleDisposed=function(e){var t;return(t=function(t){return e.publisher.fire(ue,new de(t),e)}).subscribe=function(t,n){var r={};r[ue]={method:t,once:!!n},e.Bus.add(new a(r))},t}(this),this.busy=le(this),this.Bus=new o,this.publisher=new r([re,oe,ue,ie,ae]),this.Bus.add(this.publisher)}return s(e,[{key:"getModule",value:function(e){var t,n=this;if(this.modules[e])return Promise.resolve(this.modules[e]);try{t=this.loadModule(this.appName,e)}catch(t){throw new Error("Pollon: [Kernel:module:loading] Cannot load module ".concat(e,": ").concat(t))}if(!t)throw new Error("Pollon: [Kernel:module:loading] Cannot load module ".concat(e));return t.then||(t=Promise.resolve(t)),t.then((function(t){return(t=O.create(t)).ID=e,t.Runtime=new S(e),n.modules[e]=t,t})).then((function(e){return e.Runtime.FSM.on(S.EVENTS.ON,"initialize",(function(t,r){return e.appName=r.args[0],n.moduleInitialized(e.name),e.Lifecycle&&T(e.Lifecycle.init)&&e.Lifecycle.init()})),e.Runtime.FSM.on(S.EVENTS.ENTERED,"loaded",(function(t,r){var o;return n.moduleLoaded(e.name),e.Lifecycle&&T(e.Lifecycle.onLoad)&&(o=e.Lifecycle).onLoad.apply(o,g(r.args||[]))})),e.Runtime.FSM.on(S.EVENTS.ENTERED,"bound",(function(t,n){var r;return e.Lifecycle&&T(e.Lifecycle.onApplyBindings)&&(r=e.Lifecycle.onApplyBindings).apply.apply(r,[e.Lifecycle].concat(g(n.args||[])))})),e.Runtime.FSM.on(S.EVENTS.ENTERED,"disposed",(function(t,r){var o;return n.moduleDisposed(e.name),e.Lifecycle&&T(e.Lifecycle.onDispose)&&(o=e.Lifecycle).onDispose.apply(o,g(r.args||[]))})),e.onReady=e.onReady&&e.onReady.bind(e)||function(){for(var t=arguments.length,r=new Array(t),o=0;o<t;o++)r[o]=arguments[o];return n.moduleReady(e.name,r)},e}))}},{key:"canDeactivateModule",value:function(e){var t=this;return e.Runtime?new Promise((function(n,r){var o;try{o=e.canDeactivate&&e.canDeactivate(t.appName)}catch(e){n(!1)}return o&&o.then?o.then((function(e){n(e)})).catch(n.bind(n)):n(o)})):Promise.resolve(!0)}},{key:"canActivateModule",value:function(e){for(var t=this,n=arguments.length,r=new Array(n>1?n-1:0),o=1;o<n;o++)r[o-1]=arguments[o];return e.Runtime?new Promise((function(n,o){var i;try{i=e.canActivate&&e.canActivate.apply(e,[t.appName].concat(r))}catch(e){o(e)}return i&&i.then?i.then((function(e){n(e)})).catch(o.bind(o)):n(i)})):Promise.resolve(!0)}},{key:"deactivate",value:function(e){var t=this;return console.log("deactivate",e),this.getModule(e).then((function(n){return t.canDeactivateModule(n).then((function(t){if(!t)throw new Error("Pollon: [kernel:module:deactivation] Unable to deactivate module ".concat(e));return n.Runtime.dispose()}))})).catch(console.info.bind(console))}},{key:"activate",value:function(e){for(var t=this,n=arguments.length,r=new Array(n>1?n-1:0),o=1;o<n;o++)r[o-1]=arguments[o];return e?(this.currentModule?this.deactivate(this.currentModule.Runtime.ID):Promise.resolve(!0)).then((function(){return t.getModule(e)})).then((function(e){return t.canActivateModule.apply(t,[e].concat(r))})).then((function(n){var o;if(!n)throw new Error("Pollon: [kernel:module:activation] Unable to activate module ".concat(e));return(o=t.modules[e].Runtime).initialize.apply(o,[t.appName].concat(r))})).then((function(){var n=t.modules[e];return t.loadTemplate(n)})).then((function(n){return t.modules[e].Runtime.load(n)})).then((function(){var n;(n=t.modules[e]).Runtime.node&&(n.name||(n.name="unknown-module-"+D()),n.Runtime.node.attr("data-view",n.name))})).then((function(){var n=t.modules[e];return t.applyBindings(ne.get(t.appName),n.Runtime.node.get(0),n)})).then((function(){var n;return(n=t.modules[e].Runtime).applyBindings.apply(n,r)})).then((function(){return t._transitionDelay&&u(t._transitionDelay)})).then((function(){var n;return t.currentModule=t.modules[e],t.moduleReady(t.currentModule.name,r),t.currentModule.onReady&&(n=t.currentModule).onReady.apply(n,r)})).catch(console.error.bind(console)):Promise.resolve()}},{key:"setTransitionDelay",value:function(e){this._transitionDelay=+e}}]),e}());e("RedirectCommand",(function e(t){c(this,e),this.url=t})),e("RedirectExternalURICommand",(function e(t){c(this,e),window.location.href=t}))}}}));
